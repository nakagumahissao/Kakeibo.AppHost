@page "/alterar-senha"
@using Kakeibo.AppHost.Web.Services

@rendermode InteractiveServer

@inject IHttpClientFactory HttpFactory
@inject IJSRuntime JS
@inject NavigationManager Nav
@inject Kakeibo.AppHost.Web.Services.TokenService TokenService
@inject IStringLocalizer<AlterarSenha> L

<PageTitle>@L["Alterar Senha"]</PageTitle>

<h3 style="padding-bottom:10px;">@L["Alterar Senha"]</h3>

<EditForm Model="@model" OnValidSubmit="HandleChangePassword">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="mb-3">
        <label for="currentPassword" class="form-label">
            @L["Senha Atual"]
        </label>
        <InputText id="currentPassword"
                   type="password"
                   class="form-control"
                   @bind-Value="model.CurrentPassword" />
    </div>

    <div class="mb-3">
        <label for="newPassword" class="form-label">
            @L["Nova Senha"]
        </label>
        <InputText id="newPassword"
                   type="password"
                   class="form-control"
                   @bind-Value="model.NewPassword" />
    </div>

    <div class="mb-3">
        <label for="confirmPassword" class="form-label">
            @L["Confirmar Nova Senha"]
        </label>
        <InputText id="confirmPassword"
                   type="password"
                   class="form-control"
                   @bind-Value="model.ConfirmPassword" />
    </div>

    <button class="btn btn-primary" type="submit">
        @L["Salvar"]
    </button>
</EditForm>

@code {
    ChangePasswordModel model = new();

    protected override async Task OnInitializedAsync()
    {
        var token = TokenService.GetToken();
        if (string.IsNullOrWhiteSpace(token))
        {
            Nav.NavigateTo("/login", forceLoad: true);
            return;
        }
    }

    private async Task HandleChangePassword()
    {
        if (model.NewPassword != model.ConfirmPassword)
        {
            await JS.InvokeVoidAsync("alert", L["As senhas não coincidem."]);
            return;
        }

        var client = HttpFactory.CreateClient("apis");
        var response = await client.PostAsJsonAsync("/users/change-password", model);

        if (response.IsSuccessStatusCode)
        {
            await JS.InvokeVoidAsync("alert", L["Senha alterada com sucesso!"]);
            Nav.NavigateTo("/");
            return;
        }

        var error = await response.Content.ReadAsStringAsync();
        await JS.InvokeVoidAsync("alert", L["Erro:"] + $" {error}");
    }

    public class ChangePasswordModel
    {
        public string CurrentPassword { get; set; } = string.Empty;
        public string NewPassword { get; set; } = string.Empty;
        public string ConfirmPassword { get; set; } = string.Empty;
    }
}
