@page "/register-user"
@using System.Net.Http.Json
@using System.ComponentModel.DataAnnotations
@using Microsoft.Extensions.Localization
@using Kakeibo.AppHost.Web.Models
@rendermode InteractiveServer

@inject IHttpClientFactory HttpFactory
@inject NavigationManager Nav
@inject IStringLocalizer<RegisterUser> L

<PageTitle>@L["Registro de Usuário"]</PageTitle>

<h1 style="padding-bottom:10px;">@L["Registro de Usuário"]</h1>

@if (!string.IsNullOrEmpty(Message))
{
    <div class="alert @AlertClass">@Message</div>
}

<EditForm Model="newUser" OnValidSubmit="HandleValidSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="mb-3">
        <label>@L["Email"]</label>
        <InputText class="form-control" @bind-Value="newUser.Email" />
    </div>

    <div class="mb-3">
        <label>@L["Senha"]</label>
        <InputText type="password"
                   class="form-control"
                   @bind-Value="newUser.Password" />
    </div>

    <button type="submit" class="btn btn-primary">
        @L["Registrar"]
    </button>
</EditForm>

@code {
    private UserRegistrationModel newUser = new();

    private string Message = string.Empty;
    private string AlertClass = string.Empty;

    private async Task HandleValidSubmit()
    {
        var client = HttpFactory.CreateClient("apis");

        var response = await client.PostAsJsonAsync("/register", newUser);
        var apiResponse =
            await response.Content.ReadFromJsonAsync<ApiResponse<object>>();

        if (response.IsSuccessStatusCode)
        {
            Message = $"✔ {L["Usuário criado com sucesso! Redirecionando para o login..."]}";
            AlertClass = "alert-success";

            await Task.Delay(2000);
            Nav.NavigateTo("/login");
        }
        else
        {
            var errorDetails =
                apiResponse?.Errors != null && apiResponse.Errors.Length > 0
                    ? string.Join(", ", apiResponse.Errors)
                    : L["Falha na comunicação com o servidor ou dados inválidos."];

            Message = $"{L["Erro ao registrar"]}: {errorDetails}";
            AlertClass = "alert-danger";
        }
    }

    public record ApiResponse<T>(bool Success, T? Data, string[] Errors);

    public class UserRegistrationModel
    {
        [Required(ErrorMessage = "O email é obrigatório")]
        [EmailAddress(ErrorMessage = "Email inválido")]
        public string Email { get; set; } = string.Empty;

        [Required(ErrorMessage = "A senha é obrigatória")]
        [MinLength(8, ErrorMessage = "A senha deve ter ao menos 8 caracteres")]
        public string Password { get; set; } = string.Empty;
    }
}
