@page "/register-user"
@using System.Net.Http.Json
@using System.ComponentModel.DataAnnotations
@using Kakeibo.AppHost.Web.Services
@using Kakeibo.AppHost.Web.Models
@rendermode InteractiveServer

@inject IHttpClientFactory HttpFactory
@inject TokenService TokenService

<PageTitle>Registro de Usuário</PageTitle>

<h1 style="padding-bottom:10px;">Registro de Usuário</h1>

@if (!string.IsNullOrEmpty(Message))
{
    <div class="alert @AlertClass">@Message</div>
}

<EditForm Model="newUser" OnValidSubmit="HandleValidSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="mb-3">
        <label>Email</label>
        <InputText class="form-control" @bind-Value="newUser.Email" />
    </div>

    <div class="mb-3">
        <label>Senha</label>
        <InputText type="password" class="form-control" @bind-Value="newUser.Password" />
    </div>

    <button type="submit" class="btn btn-primary">Registrar</button>
</EditForm>

@code {
    private UserRegistrationModel newUser = new();

    private string Message = "";
    private string AlertClass = "";

    private async Task HandleValidSubmit()
    {
        // usa o TokenService para criar client já com JWT
        var client = TokenService.CreateClient();

        var response = await client.PostAsJsonAsync("/users", newUser);
        var apiResponse = await response.Content.ReadFromJsonAsync<ApiResponse<object>>();

        if (apiResponse?.Success == true)
        {
            Message = $"✔ Usuário criado — ID = {apiResponse.Data}";
            AlertClass = "alert-success";
        }
        else
        {
            Message = "❌ Erro: " + string.Join(", ", apiResponse?.Errors ?? []);
            AlertClass = "alert-danger";
        }
    }

    public class UserRegistrationModel
    {
        [Required(ErrorMessage = "O email é obrigatório")]
        [EmailAddress(ErrorMessage = "Email inválido")]
        public string Email { get; set; } = "";

        [Required(ErrorMessage = "A senha é obrigatória")]
        [MinLength(8, ErrorMessage = "A senha deve ter ao menos 8 caracteres")]
        public string Password { get; set; } = "";
    }
}
