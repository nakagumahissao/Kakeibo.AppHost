@page "/saidaspage/new/{day:int}/{month:int}/{year:int}"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using System.Net.Http.Json
@using Kakeibo.AppHost.Web.Models
@inject IHttpClientFactory HttpFactory
@inject NavigationManager NavManager
@inject ILogger<Kakeibo.AppHost.Web.Components.Pages.NovaSaida> Logger
@inject Kakeibo.AppHost.Web.Services.TokenService TokenService
@inject IStringLocalizer<SharedResources> L

<PageTitle>@L["Registro de Nova Despesa"]</PageTitle>

<h1>@L["Registro de Nova Despesa"]</h1>

<EditForm Model="novaSaida" OnValidSubmit="SalvarDespesa" FormName="novaSaida">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="card p-3 mb-3">
        <!-- Hidden fields -->
        <InputHidden @bind-Value="novaSaida!.DataSaidaString" />
        <InputHidden @bind-Value="novaSaida.Ano" />
        <InputHidden @bind-Value="novaSaida.Mes" />
        <InputHidden @bind-Value="novaSaida.UserID" />

        <!-- Tipo de Despesa -->
        <div class="mb-2">
            <label>@L["Tipo de Despesa"]</label>
            <InputSelect id="despesaID"
                         class="form-select"
                         @bind-Value="novaSaida.DespesaID">
                <option value="0">@L["Selecione"]</option>

                @foreach (var tipo in despesa?? Enumerable.Empty<Despesa>())
                {
                    <option value="@tipo.DespesaId">
                        @tipo.NomeDespesa
                    </option>
                }
            </InputSelect>
        </div>

        <!-- Nome da Despesa -->
        <div class="mb-2">
            <label>@L["Nome da Despesa"]</label>
            <InputText class="form-control"
                       @bind-Value="novaSaida.NomeDespesa" />
            <ValidationMessage For="@(() => novaSaida.NomeDespesa)" />
        </div>

        <!-- Descrição -->
        <div class="mb-2">
            <label>@L["Descrição"]</label>
            <InputText class="form-control"
                       @bind-Value="novaSaida.Descricao" />
            <ValidationMessage For="@(() => novaSaida.Descricao)" />
        </div>

        <!-- Valor -->
        <div class="mb-2">
            <label>@L["Valor"]</label>
            <InputNumber class="form-control"
                         @bind-Value="novaSaida.ValorDespesa" />
            <ValidationMessage For="@(() => novaSaida.ValorDespesa)" />
        </div>

        <div class="d-flex justify-content-end mt-3">
            <button type="submit" class="btn btn-primary me-2">
                @L["Salvar"]
            </button>

            <a class="btn btn-secondary"
               href="@($"/saidaspage/{UserID}/{Day}/{Month}/{Year}")">
                @L["Cancelar"]
            </a>
        </div>
    </div>
</EditForm>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger mt-3">
        @errorMessage
    </div>
}

@if (!string.IsNullOrEmpty(successMessage))
{
    <div class="alert alert-success mt-3">
        @((MarkupString)successMessage)
    </div>
}

@code {
    [Parameter] public int Day { get; set; }
    [Parameter] public int Month { get; set; }
    [Parameter] public int Year { get; set; }

    [SupplyParameterFromForm]
    private Saidas? novaSaida { get; set; }

    private List<Despesa> despesa = new();
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;
    private string? UserID = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        var token = TokenService.GetToken();
        if (string.IsNullOrWhiteSpace(token))
        {
            NavManager.NavigateTo("/login", forceLoad: true);
            return;
        }

        UserID = TokenService.GetUserIdFromToken();

        novaSaida ??= new Saidas
        {
            DataSaida = DateTime.Today,
            Ano = DateTime.Today.Year.ToString("0000"),
            Mes = DateTime.Today.Month.ToString("00"),
            UserID = UserID!,
            DespesaID = 0,
            NomeDespesa = "",
            Descricao = "",
            ValorDespesa = 0m,
            DataSaidaString = DateTime.Today.ToString("yyyy-MM-dd")
        };

        await CarregarTiposDespesa();
    }

    private async Task CarregarTiposDespesa()
    {
        var client = HttpFactory.CreateClient("apis");
        despesa =
            await client.GetFromJsonAsync<List<Despesa>>(
                $"despesas/{UserID}"
            )
            ?? new List<Despesa>();
    }

    protected override async Task OnParametersSetAsync()
    {
        var dt = (Day > 0 && Month > 0 && Year > 0)
            ? new DateTime(Year, Month, Day)
            : DateTime.Today;

        novaSaida ??= new Saidas
        {
            DataSaida = dt,
            Ano = dt.Year.ToString("0000"),
            Mes = dt.Month.ToString("00"),
            UserID = UserID!,
            DespesaID = 0,
            NomeDespesa = "",
            Descricao = "",
            ValorDespesa = 0m,
            DataSaidaString = dt.ToString("yyyy-MM-dd")
        };

        novaSaida.DataSaida = dt;

        await CarregarTiposDespesa();
    }

    private async Task SalvarDespesa()
    {
        errorMessage = string.Empty;

        try
        {
            var dt = (Day > 0 && Month > 0 && Year > 0)
                ? new DateTime(Year, Month, Day)
                : DateTime.Today;

            novaSaida!.DataSaida = dt;

            var client = HttpFactory.CreateClient("apis");
            var response = await client.PostAsJsonAsync("saidas", novaSaida);

            if (!response.IsSuccessStatusCode)
            {
                errorMessage = $"{L["Erro ao salvar"]}: {response.StatusCode}";
                return;
            }

            var targetUrl = $"/saidaspage/{Day}/{Month}/{Year}";
            NavManager.NavigateTo(targetUrl);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "SalvarDespesa failed");
            errorMessage = ex.ToString();
        }
    }
}
