@page "/rendas/new"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Forms

@using System.Net.Http.Json
@using System.Text.Json
@using Kakeibo.AppHost.Web.Models

@inject IHttpClientFactory HttpFactory
@inject NavigationManager Navigation
@inject Kakeibo.AppHost.Web.Services.TokenService TokenService
@inject IStringLocalizer<NovaRenda> L

<PageTitle>@L["Nova Renda"]</PageTitle>

<h1>@L["Nova Renda"]</h1>

<EditForm Model="novaEntrada" OnValidSubmit="SalvarEntrada" FormName="novaEntradaForm">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="card p-3 mb-3">
        <div class="mb-2">
            <InputHidden id="anoEntrada" @bind-Value="novaEntrada!.Ano" />
            <InputHidden id="mesEntrada" @bind-Value="novaEntrada.Mes" />
            <InputHidden id="userIDEntrada" @bind-Value="novaEntrada.UserID" />

            <InputSelect id="tipoEntrada"
                         TValue="int"
                         class="form-select"
                         @bind-Value="novaEntrada.TipoDeEntradaID">
                <option value="0">@L["Selecione"]</option>

                @foreach (var tipo in tiposEntrada ?? Enumerable.Empty<TiposDeEntradas>())
                {
                    <option value="@tipo.TipoDeEntradaId">
                        @tipo.TipoDeEntrada
                    </option>
                }
            </InputSelect>
        </div>

        <div class="mb-2">
            <label>@L["Descrição"]</label>
            <InputText id="descricao"
                       class="form-control"
                       @bind-Value="novaEntrada.Descricao" />
            <ValidationMessage For="@(() => novaEntrada.Descricao)" />
        </div>

        <div class="mb-2">
            <label>@L["Valor"]</label>
            <InputNumber id="valorEntrada"
                         TValue="decimal"
                         class="form-control"
                         @bind-Value="novaEntrada.ValorEntrada" />
            <ValidationMessage For="@(() => novaEntrada.ValorEntrada)" />
        </div>

        <div class="d-flex justify-content-end mt-3">
            <button type="submit" class="btn btn-primary me-2">
                @L["Salvar"]
            </button>

            <a href="/rendas" class="btn btn-secondary">
                @L["Cancelar"]
            </a>
        </div>
    </div>
</EditForm>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger mt-3" role="alert">
        @errorMessage
    </div>
}

@code {
    private List<TiposDeEntradas>? tiposEntrada;
    private string errorMessage = string.Empty;

    private string? UserID = string.Empty;

    [SupplyParameterFromForm]
    private Entradas? novaEntrada { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var token = TokenService.GetToken();
        if (string.IsNullOrWhiteSpace(token))
        {
            Navigation.NavigateTo("/login", forceLoad: true);
            return;
        }

        UserID = TokenService.GetUserIdFromToken();

        var apisClient = HttpFactory.CreateClient("apis");

        novaEntrada ??= new()
        {
            Ano = DateTime.Today.Year.ToString("0000"),
            Mes = DateTime.Today.Month.ToString("00"),
            UserID = UserID!
        };

        try
        {
            tiposEntrada =
                await apisClient.GetFromJsonAsync<List<TiposDeEntradas>>(
                    $"tiposentrada/{UserID}"
                );

            tiposEntrada ??= new List<TiposDeEntradas>();
        }
        catch (OperationCanceledException)
        {
            // unchanged
        }
        catch (HttpRequestException ex)
        {
            errorMessage = $"{L["Falha ao carregar tipos de entrada"]}: {ex.Message}";
            tiposEntrada = new List<TiposDeEntradas>();
        }
        catch (Exception ex)
        {
            errorMessage = $"{L["Erro inesperado ao carregar dados"]}: {ex.Message}";
            tiposEntrada = new List<TiposDeEntradas>();
        }
    }

    private async Task SalvarEntrada()
    {
        errorMessage = string.Empty;

        if (novaEntrada != null)
        {
            novaEntrada.Ano = DateTime.Today.Year.ToString("0000");
            novaEntrada.Mes = DateTime.Today.Month.ToString("00");
            novaEntrada.UserID = UserID!;
        }

        var apisClient = HttpFactory.CreateClient("apis");

        using var request = new HttpRequestMessage(HttpMethod.Post, "entradas")
        {
            Content = JsonContent.Create(novaEntrada)
        };

        try
        {
            using var response = await apisClient.SendAsync(
                request,
                HttpCompletionOption.ResponseHeadersRead
            );

            if (!response.IsSuccessStatusCode)
            {
                errorMessage = $"{L["Erro ao salvar"]}: {response.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"{L["Erro ao salvar"]}: {ex.GetType().Name} {ex.Message}";
        }
        finally
        {
            Navigation.NavigateTo("/rendas", forceLoad: true);
        }
    }
}
