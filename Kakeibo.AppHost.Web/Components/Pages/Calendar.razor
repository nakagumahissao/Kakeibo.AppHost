@page "/calendar"
@using System.Globalization
@rendermode InteractiveServer

@inject IStringLocalizer<Calendar> L

<PageTitle>@L["Calendário"]</PageTitle>

<h3 style="padding-bottom:10px;">@L["Calendário"]</h3>

<div class="d-flex align-items-center mb-3">
    <label for="yearSelect" class="me-2">
        @L["Select year:"]
    </label>

    <select id="yearSelect"
            class="form-select w-auto"
            @bind="SelectedYear"
            @bind:after="OnYearChanged">
        @foreach (var year in Years)
        {
            <option value="@year">@year</option>
        }
    </select>
</div>

@if (CalendarMonths is not null)
{
    <div class="container">

        @foreach (var row in CalendarMonths.Chunk(3))
        {
            <div class="row mb-4">

                @foreach (var month in row)
                {
                    <div class="col-md-4 mb-4">
                        <div class="calendar-month border p-2 rounded">

                            <div class="month-header text-center p-1 mb-2"
                                 style="background-color:#fff9cc; font-weight:bold;">
                                @month.MonthName
                            </div>

                            <table class="table table-bordered table-sm text-center">
                                <thead>
                                    <tr>
                                        @foreach (var day in DayNames)
                                        {
                                            <th style="background-color:#e8ffe8;">
                                                @day
                                            </th>
                                        }
                                    </tr>
                                </thead>

                                <tbody>
                                    @foreach (var week in month.Weeks)
                                    {
                                        <tr>
                                            @foreach (var day in week)
                                            {
                                                <td style="height:32px;">
                                                    @(day?.Day.ToString() ?? "")
                                                </td>
                                            }
                                        </tr>
                                    }
                                </tbody>
                            </table>

                        </div>
                    </div>
                }

            </div>
        }

    </div>
}

@code {

    public int SelectedYear { get; set; } = DateTime.Now.Year;

    public List<int> Years { get; } = Enumerable.Range(2025, 60).ToList();

    public List<CalendarMonth>? CalendarMonths;

    private string[] DayNames = Array.Empty<string>();

    protected override void OnInitialized()
    {
        InitializeDayNames();
        GenerateCalendar(SelectedYear);
    }

    private void OnYearChanged()
    {
        GenerateCalendar(SelectedYear);
    }

    private void InitializeDayNames()
    {
        var culture = CultureInfo.CurrentCulture;
        var dtf = culture.DateTimeFormat;

        int firstDay = (int)dtf.FirstDayOfWeek;
        var names = dtf.AbbreviatedDayNames;

        DayNames = Enumerable.Range(0, 7)
            .Select(i => names[(i + firstDay) % 7])
            .ToArray();
    }

    private void GenerateCalendar(int year)
    {
        CalendarMonths = new();

        var culture = CultureInfo.CurrentCulture;
        int cultureFirstDay = (int)culture.DateTimeFormat.FirstDayOfWeek;

        for (int month = 1; month <= 12; month++)
        {
            var firstDayOfMonth = new DateTime(year, month, 1);
            int daysInMonth = DateTime.DaysInMonth(year, month);

            var monthObj = new CalendarMonth
            {
                MonthName = firstDayOfMonth.ToString("MMMM yyyy", culture)
            };

            var weeks = new List<List<DateTime?>>();
            var currentWeek = new List<DateTime?>();

            int offset =
                ((int)firstDayOfMonth.DayOfWeek - cultureFirstDay + 7) % 7;

            for (int i = 0; i < offset; i++)
                currentWeek.Add(null);

            for (int day = 1; day <= daysInMonth; day++)
            {
                currentWeek.Add(new DateTime(year, month, day));

                if (currentWeek.Count == 7)
                {
                    weeks.Add(currentWeek);
                    currentWeek = new();
                }
            }

            if (currentWeek.Count > 0)
            {
                while (currentWeek.Count < 7)
                    currentWeek.Add(null);

                weeks.Add(currentWeek);
            }

            monthObj.Weeks = weeks;
            CalendarMonths.Add(monthObj);
        }
    }

    public class CalendarMonth
    {
        public string MonthName { get; set; } = string.Empty;
        public List<List<DateTime?>> Weeks { get; set; } = new();
    }
}
